name: Build and Merge main-preview to main

on:
  push:
    branches:
      - main-preview

jobs:
  build-and-merge:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write
    steps:
      - name: Checkout main-preview branch
        uses: actions/checkout@v3
        with:
          ref: main-preview
          fetch-depth: 0

      - name: Check for unallowed files
        run: |
          echo "Checking for unallowed files in commits..."
          
          # Fetch all branches to compare
          git fetch origin main || true
          
          # Get the list of changed files compared to main branch
          if git rev-parse --verify origin/main >/dev/null 2>&1; then
            CHANGED_FILES=$(git diff --name-only origin/main...HEAD 2>/dev/null || echo "")
          else
            # If main doesn't exist remotely, check files in the last commit
            CHANGED_FILES=$(git diff --name-only HEAD~1..HEAD 2>/dev/null || git ls-tree -r --name-only HEAD || echo "")
          fi
          
          if [ -z "$CHANGED_FILES" ]; then
            # If no diff available, check all tracked files
            CHANGED_FILES=$(git ls-files)
          fi
          
          # Patterns for unallowed files
          UNALLOWED_PATTERNS=(
            "\.env$"
            "\.env\."
            "\.pem$"
            "\.key$"
            "\.p12$"
            "\.pfx$"
            "id_rsa$"
            "id_dsa$"
            "\.crt$"
            "\.cer$"
            "\.der$"
            "dump\.rdb$"
            "\.log$"
            "^dist/"
            "^dist-ssr/"
          )
          
          VIOLATIONS=""
          
          # Check each changed file against unallowed patterns
          while IFS= read -r file; do
            if [ -z "$file" ]; then
              continue
            fi
            
            # Skip node_modules and .git directories
            if echo "$file" | grep -qE "(node_modules|\.git)"; then
              continue
            fi
            
            for pattern in "${UNALLOWED_PATTERNS[@]}"; do
              if echo "$file" | grep -qE "$pattern"; then
                VIOLATIONS="${VIOLATIONS}  - $file\n"
                break
              fi
            done
            
            # Check file size if file exists (10MB limit)
            if [ -f "$file" ]; then
              FILE_SIZE=$(stat -f%z "$file" 2>/dev/null || stat -c%s "$file" 2>/dev/null || echo "0")
              if [ "$FILE_SIZE" -gt 10485760 ]; then
                SIZE_MB=$((FILE_SIZE / 1048576))
                VIOLATIONS="${VIOLATIONS}  - $file (size: ${SIZE_MB}MB, exceeds 10MB limit)\n"
              fi
            fi
          done <<< "$CHANGED_FILES"
          
          if [ -n "$VIOLATIONS" ]; then
            echo "❌ ERROR: Unallowed files detected in commit!"
            echo ""
            echo "The following files violate the merge policy:"
            echo -e "$VIOLATIONS"
            echo ""
            echo "Please remove these files before merging."
            exit 1
          fi
          
          echo "✅ No unallowed files detected. Proceeding with merge..."

      - name: Set up Node.js
        uses: actions/setup-node@v3
        with:
          node-version: '18'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Run linter
        run: npm run lint

      - name: Build project
        run: npm run build:student

      - name: Create and merge Pull Request
        env:
          GITHUB_TOKEN: ${{ secrets.Ivy_league_PAT }}
        run: |
          # Check if there are any differences between branches
          git fetch origin main || true
          
          if git rev-parse --verify origin/main >/dev/null 2>&1; then
            # Check if branches are already in sync
            if git diff --quiet origin/main...HEAD; then
              echo "✅ Branches are already in sync. No merge needed."
              exit 0
            fi
          fi
          
          # Create pull request using GitHub API
          PR_RESPONSE=$(curl -s -X POST \
            -H "Accept: application/vnd.github.v3+json" \
            -H "Authorization: token $GITHUB_TOKEN" \
            "https://api.github.com/repos/${{ github.repository }}/pulls" \
            -d "{
              \"title\": \"Auto-merge: main-preview → main [skip ci]\",
              \"head\": \"main-preview\",
              \"base\": \"main\",
              \"body\": \"Automatically created by GitHub Actions after successful build and validation.\"
            }")
          
          PR_NUMBER=$(echo "$PR_RESPONSE" | grep -o '"number":[0-9]*' | grep -o '[0-9]*' | head -1)
          
          if [ -z "$PR_NUMBER" ]; then
            # Check if PR already exists
            EXISTING_PR=$(curl -s -X GET \
              -H "Accept: application/vnd.github.v3+json" \
              -H "Authorization: token $GITHUB_TOKEN" \
              "https://api.github.com/repos/${{ github.repository }}/pulls?head=${{ github.repository_owner }}:main-preview&base=main&state=open")
            
            PR_NUMBER=$(echo "$EXISTING_PR" | grep -o '"number":[0-9]*' | grep -o '[0-9]*' | head -1)
            
            if [ -z "$PR_NUMBER" ]; then
              echo "❌ Failed to create or find pull request"
              echo "$PR_RESPONSE"
              exit 1
            else
              echo "✅ Found existing pull request #$PR_NUMBER"
            fi
          else
            echo "✅ Created pull request #$PR_NUMBER"
          fi
          
          # Merge the pull request
          MERGE_RESPONSE=$(curl -s -X PUT \
            -H "Accept: application/vnd.github.v3+json" \
            -H "Authorization: token $GITHUB_TOKEN" \
            "https://api.github.com/repos/${{ github.repository }}/pulls/$PR_NUMBER/merge" \
            -d "{
              \"commit_title\": \"Auto-merge main-preview to main [skip ci]\",
              \"merge_method\": \"merge\"
            }")
          
          MERGED=$(echo "$MERGE_RESPONSE" | grep -o '"merged":[^,]*' | grep -o 'true\|false')
          
          if [ "$MERGED" = "true" ]; then
            echo "✅ Successfully merged pull request #$PR_NUMBER"
          else
            echo "❌ Failed to merge pull request"
            echo "$MERGE_RESPONSE"
            exit 1
          fi

